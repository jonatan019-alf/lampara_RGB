<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Color Wheel WS2812B – FIEL</title>

<style>
body {
  margin: 0;
  background: #111;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  color: #fff;
}
button {
  margin-bottom: 10px;
  padding: 10px 18px;
  font-size: 16px;
}
canvas { touch-action: none; }
</style>
</head>

<body>

<button id="btnConnect">Conectar BLE</button>
<canvas id="wheel" width="320" height="320"></canvas>

<script>
/* ======================================================
   BLE
====================================================== */
const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
const CHAR_UUID    = "abcd1234-1234-1234-1234-abcdef123456";

let characteristic = null;
let busy = false;
let pending = null;

async function conectarBLE() {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ services: [SERVICE_UUID] }]
  });
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  characteristic = await service.getCharacteristic(CHAR_UUID);
  console.log("BLE conectado");
}

document.getElementById("btnConnect").onclick = conectarBLE;

async function enviarRGB(r,g,b) {
  if (!characteristic) return;
  if (busy) { pending=[r,g,b]; return; }
  busy = true;
  await characteristic.writeValue(new Uint8Array([r,g,b]));
  busy = false;
  if (pending) { const p=pending; pending=null; enviarRGB(...p); }
}

/* ======================================================
   CORRECCIÓN WS2812B
====================================================== */
function corregirWS2812(r,g,b) {
  // gamma
  const gamma = 2.2;
  r = Math.pow(r/255, gamma) * 255;
  g = Math.pow(g/255, gamma) * 255;
  b = Math.pow(b/255, gamma) * 255;

  // balance típico WS2812B
  g *= 0.75;   // el verde domina
  b *= 0.9;

  return [
    Math.min(255, r)|0,
    Math.min(255, g)|0,
    Math.min(255, b)|0
  ];
}

/* ======================================================
   CANVAS (solo visual)
====================================================== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const w = canvas.width, h = canvas.height;
const cx = w/2, cy = h/2, radius = w/2;

const img = ctx.createImageData(w,h);
const d = img.data;

for (let y=0;y<h;y++) {
  for (let x=0;x<w;x++) {
    const dx=x-cx, dy=y-cy;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if (dist>radius) continue;

    let a=Math.atan2(dy,dx);
    if (a<0) a+=Math.PI*2;
    const hue=a/(Math.PI*2);

    const i=(y*w+x)*4;
    const r = Math.max(0, Math.min(255, Math.cos((hue)*2*Math.PI)*127+128));
    const g = Math.max(0, Math.min(255, Math.cos((hue-1/3)*2*Math.PI)*127+128));
    const b = Math.max(0, Math.min(255, Math.cos((hue-2/3)*2*Math.PI)*127+128));

    d[i]=r; d[i+1]=g; d[i+2]=b; d[i+3]=255;
  }
}
ctx.putImageData(img,0,0);

/* ======================================================
   PICK REAL (LEE EL PIXEL)
====================================================== */
function procesar(x,y){
  const px = ctx.getImageData(x,y,1,1).data;
  if (px[3] === 0) return; // fuera del círculo

  const [r,g,b] = corregirWS2812(px[0],px[1],px[2]);

    `PIXEL: rgb(${px[0]},${px[1]},${px[2]}) → ` +
    `LED: rgb(${r},${g},${b})`

  enviarRGB(r,g,b);
}

canvas.addEventListener("mousemove",e=>{
  const r=canvas.getBoundingClientRect();
  procesar(e.clientX-r.left|0,e.clientY-r.top|0);
});

canvas.addEventListener("touchmove",e=>{
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  const t=e.touches[0];
  procesar(t.clientX-r.left|0,t.clientY-r.top|0);
});
</script>

</body>
</html>
